services:
  # This is the knowledge directory, facilitating discovery between different runtimes. It exposes its service over port 8282.
  kd:
    image: ghcr.io/tno/knowledge-engine/knowledge-directory:1.2.3

  # We create one runtime that contains the different test knowledge bases. This runtime is available via port 8280 
  kbs-runtime:
    image: ghcr.io/tno/knowledge-engine/smart-connector:1.3.1
    environment: 
      KE_RUNTIME_PORT: 8081
      KE_RUNTIME_EXPOSED_URL: http://kbs-runtime:8081
      KD_URL: http://kd:8282
      KE_REASONER_LEVEL: 4
    ports:
      - "8280:8280"

  # One KB is added to answer questions about historic events and when they occurred
  historic-events-kb:
    build: ./knowledge-network/answering_kb
    environment:
      KE_URL: http://kbs-runtime:8280/rest
      KB_ID: http://example.org/a-historic-events-knowledge-base-id
      PREFIXES: |
        {
          "ex": "http://example.org/"
        }
      GRAPH_PATTERN: |
        ?event ex:hasOccurredAt ?datetime .
        ?event ex:hasNumberOfPeople ?people .
      KB_DATA: |
        [
          {
            "event": "<http://example.org/BiggestClimateStrikes>",
            "datetime": "\"2019-09-20T09:00:00+00:00\"^^<http://www.w3.org/2001/XMLSchema#dateTime>",
            "people": "\"7600000\"^^<http://www.w3.org/2001/XMLSchema#integer>"
          },
          {
            "event": "<http://example.org/FirstLandingOnTheMoon>",
            "datetime": "\"1969-07-20T20:05:00+00:00\"^^<http://www.w3.org/2001/XMLSchema#dateTime>",
            "people": "\"500\"^^<http://www.w3.org/2001/XMLSchema#integer>"
          },
          {
            "event": "<http://example.org/IntroductionOfTheEuro>",
            "datetime": "\"2002-01-01T00:00:00+00:00\"^^<http://www.w3.org/2001/XMLSchema#dateTime>",
            "people": "\"100\"^^<http://www.w3.org/2001/XMLSchema#integer>"
          }
        ]


  # Another KB is added to answer questions about persons involved in historic events
  persons-involved-kb:
    build: ./knowledge-network/answering_kb
    environment:
      KE_URL: http://kbs-runtime:8280/rest
      KB_ID: http://example.org/a-persons-involved-knowledge-base-id
      PREFIXES: |
        {
          "ex": "http://example.org/"
        }
      GRAPH_PATTERN: |
        ?event ex:mainPersonsInvolved ?person .
      KB_DATA: |
        [
          {
            "event": "<http://example.org/FirstLandingOnTheMoon>",
            "person": "<http://example.org/Neil_Armstrong>"
          },
          {
            "event": "<http://example.org/BiggestClimateStrikes>",
            "person": "<http://example.org/Greta_Thunberg>"
          }
        ]

  # Another KB is added to react to posts about main historic events and where they took place
  main-historic-event-locations-kb:
    build: ./knowledge-network/react_kb
    environment:
      KE_URL: http://kbs-runtime:8280/rest
      KB_ID: http://example.org/a-main-historic-event-locations-knowledge-base-id
      PREFIXES: |
        {
          "ex": "http://example.org/"
        }
      ARGUMENT_GRAPH_PATTERN: |
        ?event a ex:MainHistoricEvent .
      RESULT_GRAPH_PATTERN: |
        ?event ex:occurredAtLocation ?location .
      KB_DATA: |
        [
          {
            "event": "<http://example.org/FirstLandingOnTheMoon>",
            "location": "<http://example.org/Moon>"
          }
        ]

  # Add a test service that runs through a large number of tests on a SPARQL endpoint
  test-service:
    build:
      context: ./
      additional_contexts:
        src: ../
      dockerfile: ./Dockerfile
    environment:
      - KNOWLEDGE_ENGINE_URL=http://host.docker.internal:8280/rest
      - KNOWLEDGE_BASE_ID_PREFIX=https://ke/sparql-endpoint/
      - TOKEN_ENABLED=False
      - LOG_LEVEL=DEBUG
    #healthcheck:
    #  test: ["CMD", "curl", "-f", "http://:8280/rest/sc"]
    #  interval: 10s
    #  timeout: 5s
    #  retries: 5        
    #depends_on:
    #  daikin-km:
    #    condition: 

